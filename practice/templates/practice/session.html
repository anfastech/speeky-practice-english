<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>{{ scenario.title }} ‚Äî Speeky</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=DM+Sans:wght@400;500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4169E1;
      --surface: #E6E6FA;
      --ink: #0D0D0D;
      --ink-muted: #5A5A72;
      --success: #22C55E;
      --warn: #F59E0B;
      --error: #EF4444;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'DM Sans', sans-serif; background: #f0f0f8; display: flex; flex-direction: column; }
    .heading { font-family: 'Plus Jakarta Sans', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }

    /* Chat container fills remaining space */
    #chat-area {
      flex: 1;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #chat-area::-webkit-scrollbar { width: 3px; }
    #chat-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

    /* Message bubbles */
    .bubble-ai {
      background: white;
      border-radius: 4px 18px 18px 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .bubble-user {
      background: var(--primary);
      color: white;
      border-radius: 18px 4px 18px 18px;
    }

    /* Recording button */
    .mic-btn {
      width: 60px; height: 60px;
      border-radius: 50%;
      background: var(--primary);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      user-select: none;
      touch-action: none;
      border: none;
      outline: none;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }
    .mic-btn.recording {
      background: var(--error);
      transform: scale(1.08);
    }
    .mic-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Pulse ring animation */
    @keyframes pulse-out {
      0% { transform: scale(1); opacity: 0.6; }
      100% { transform: scale(1.7); opacity: 0; }
    }
    .pulse-ring {
      position: absolute;
      width: 60px; height: 60px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.3);
      animation: pulse-out 1.2s ease-out infinite;
      pointer-events: none;
    }

    /* Typing dots */
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }
    .dot { animation: blink 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    /* Feedback card */
    @keyframes slide-up {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .feedback-card { animation: slide-up 0.25s ease-out; }

    /* Score badge pop */
    @keyframes score-pop {
      0% { transform: scale(0.7); opacity: 0; }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }
    .score-pop { animation: score-pop 0.4s ease-out; }

    /* Input footer */
    #input-footer {
      background: white;
      border-top: 1px solid #ececec;
      padding: 12px 16px;
      flex-shrink: 0;
    }

    /* Scenario header */
    #scenario-header {
      background: white;
      border-bottom: 1px solid #ececec;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

  <!-- ‚îÄ‚îÄ SCENARIO HEADER ‚îÄ‚îÄ -->
  <header id="scenario-header">
    <div class="px-4 pt-3 pb-2 flex items-center gap-3">
      <!-- Back -->
      <a href="/" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <path d="M19 12H5M12 5l-7 7 7 7"/>
        </svg>
      </a>

      <!-- Icon + title -->
      <div class="flex items-center gap-2 flex-1 min-w-0">
        <span class="text-xl flex-shrink-0">{{ scenario.icon }}</span>
        <div class="min-w-0">
          <h1 class="text-sm font-bold heading text-gray-900 truncate">{{ scenario.title }}</h1>
          <p class="text-xs text-gray-400">{{ scenario.ai_persona|capfirst }} &middot; Turn <span id="turn-num">1</span> of 3</p>
        </div>
      </div>

      <!-- Malayalam toggle -->
      <button id="ml-toggle" class="flex-shrink-0 text-xs px-3 py-1.5 rounded-full border border-indigo-200 text-indigo-500 hover:bg-indigo-50 transition-colors">
        üåê ML
      </button>
    </div>

    <!-- Situation box -->
    <div class="px-4 pb-3">
      <div class="bg-indigo-50 rounded-2xl px-4 py-3 text-sm text-gray-700 border border-indigo-100">
        <p id="sit-en">{{ scenario.situation_text }}</p>
        <p id="sit-ml" class="text-indigo-600 text-xs mt-1.5 italic hidden">{{ scenario.situation_malayalam }}</p>
      </div>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ -->
  <main id="chat-area">

    <!-- AI opening message -->
    <div class="flex items-end gap-2">
      <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-base flex-shrink-0">{{ scenario.icon }}</div>
      <div class="max-w-[82%]">
        <div class="bubble-ai px-4 py-3 text-sm leading-relaxed text-gray-800">
          {{ scenario.starter_message }}
        </div>
        <p class="text-xs text-gray-400 mt-1 ml-1">{{ scenario.ai_persona|capfirst }}</p>
      </div>
    </div>

    <!-- Dynamic messages injected here -->
    <div id="msg-container"></div>

    <!-- Typing indicator (hidden until AI is processing) -->
    <div id="typing" class="flex items-end gap-2 hidden">
      <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-base flex-shrink-0">{{ scenario.icon }}</div>
      <div class="bubble-ai px-4 py-3">
        <div class="flex gap-1 items-center h-4">
          <span class="dot w-2 h-2 bg-gray-400 rounded-full"></span>
          <span class="dot w-2 h-2 bg-gray-400 rounded-full"></span>
          <span class="dot w-2 h-2 bg-gray-400 rounded-full"></span>
        </div>
      </div>
    </div>

    <!-- Spacer so last message isn't hidden behind footer -->
    <div class="h-2"></div>
  </main>

  <!-- ‚îÄ‚îÄ INPUT FOOTER ‚îÄ‚îÄ -->
  <footer id="input-footer">

    <!-- Audio mode (default) -->
    <div id="audio-mode" class="flex items-center gap-3">
      <button id="kb-btn" title="Switch to keyboard"
        class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition-colors flex-shrink-0">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M8 8h.01M12 8h.01M16 8h.01M8 12h.01M12 12h.01M16 12h.01M8 16h4"/>
        </svg>
      </button>

      <div class="flex-1 flex flex-col items-center gap-1">
        <p id="mic-hint" class="text-xs text-gray-400">Hold to speak &bull; Release to send</p>
        <div class="relative flex items-center justify-center">
          <div id="pulse" class="pulse-ring hidden"></div>
          <button id="mic-btn" class="mic-btn" aria-label="Hold to record">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="white">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
              <line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <p id="rec-timer" class="text-xs text-red-500 font-mono hidden">‚óè 0:00</p>
      </div>

      <div class="w-10 flex-shrink-0"></div>
    </div>

    <!-- Text mode (toggled) -->
    <div id="text-mode" class="hidden flex items-center gap-2">
      <button id="mic-btn2" title="Switch to voice"
        class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition-colors flex-shrink-0">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        </svg>
      </button>
      <input id="txt-input" type="text" placeholder="Type your response here..."
        class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 text-gray-800"/>
      <button id="send-btn" aria-label="Send"
        class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-colors"
        style="background: var(--primary)">
        <svg width="16" height="16" fill="white" viewBox="0 0 24 24">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
  </footer>

  <!-- ‚îÄ‚îÄ SESSION COMPLETE MODAL ‚îÄ‚îÄ -->
  <div id="done-modal" class="hidden fixed inset-0 bg-black/50 flex items-end justify-center z-50 px-4 pb-0">
    <div class="bg-white rounded-t-3xl w-full max-w-lg p-6 pb-10 shadow-2xl">
      <div class="text-center mb-5">
        <div class="text-5xl mb-3">üéâ</div>
        <h2 class="text-xl font-bold heading text-gray-900">Scenario Complete!</h2>
        <p class="text-sm text-gray-400 mt-1">Great work finishing this conversation.</p>
      </div>
      <div id="done-score" class="flex flex-col items-center mb-6"></div>
      <div class="flex gap-3">
        <a href="/" class="flex-1 py-3 rounded-2xl border border-gray-200 text-center text-sm font-semibold text-gray-600 hover:bg-gray-50 transition-colors">
          ‚Üê Home
        </a>
        <button id="retry-btn"
          class="flex-1 py-3 rounded-2xl text-center text-sm font-semibold text-white transition-colors"
          style="background: var(--primary)">
          Try Again üîÑ
        </button>
      </div>
    </div>
  </div>

<!-- ‚îÄ‚îÄ JAVASCRIPT ‚îÄ‚îÄ -->
<script>
const SCENARIO_ID = "{{ scenario.id }}";
const CSRF = "{{ csrf_token }}";
const SCENARIO_ICON = "{{ scenario.icon }}";
const SCENARIO_PERSONA = "{{ scenario.ai_persona|capfirst }}";

let turnCount = 0;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let recSecs = 0;
let recInterval = null;
let scores = [];
let inputLocked = false;

// DOM
const chatArea = document.getElementById('chat-area');
const msgContainer = document.getElementById('msg-container');
const typing = document.getElementById('typing');
const micBtn = document.getElementById('mic-btn');
const pulse = document.getElementById('pulse');
const micHint = document.getElementById('mic-hint');
const recTimer = document.getElementById('rec-timer');
const audioMode = document.getElementById('audio-mode');
const textMode = document.getElementById('text-mode');
const txtInput = document.getElementById('txt-input');
const sendBtn = document.getElementById('send-btn');
const turnNum = document.getElementById('turn-num');

// ‚îÄ‚îÄ TOGGLE INPUT MODE ‚îÄ‚îÄ
document.getElementById('kb-btn').addEventListener('click', () => {
  audioMode.classList.add('hidden');
  textMode.classList.remove('hidden');
  txtInput.focus();
});
document.getElementById('mic-btn2').addEventListener('click', () => {
  textMode.classList.add('hidden');
  audioMode.classList.remove('hidden');
});

// ‚îÄ‚îÄ MALAYALAM TOGGLE ‚îÄ‚îÄ
document.getElementById('ml-toggle').addEventListener('click', () => {
  document.getElementById('sit-ml').classList.toggle('hidden');
});

// ‚îÄ‚îÄ TEXT SEND ‚îÄ‚îÄ
function sendText() {
  const text = txtInput.value.trim();
  if (!text || inputLocked || turnCount >= 3) return;
  txtInput.value = '';
  dispatch({ text });
}
sendBtn.addEventListener('click', sendText);
txtInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendText(); });

// ‚îÄ‚îÄ RECORDING ‚îÄ‚îÄ
function startRec() {
  if (isRecording || inputLocked || turnCount >= 3) return;

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      isRecording = true;
      audioChunks = [];
      recSecs = 0;

      // Try supported MIME types
      const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
        ? 'audio/webm;codecs=opus'
        : MediaRecorder.isTypeSupported('audio/webm')
        ? 'audio/webm'
        : 'audio/ogg';

      mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        const blob = new Blob(audioChunks, { type: mimeType });
        if (blob.size > 500) {
          sendAudio(blob, mimeType);
        }
      };
      mediaRecorder.start(100); // collect chunks every 100ms

      // UI
      micBtn.classList.add('recording');
      pulse.classList.remove('hidden');
      micHint.textContent = 'Release to send';
      recTimer.classList.remove('hidden');

      recInterval = setInterval(() => {
        recSecs++;
        const m = Math.floor(recSecs / 60);
        const s = String(recSecs % 60).padStart(2, '0');
        recTimer.textContent = `‚óè ${m}:${s}`;
        if (recSecs >= 90) stopRec(); // max 90s
      }, 1000);
    })
    .catch(() => {
      // Mic denied ‚Äî fall back to text
      audioMode.classList.add('hidden');
      textMode.classList.remove('hidden');
      txtInput.placeholder = 'Mic unavailable ‚Äî type your response here...';
      txtInput.focus();
    });
}

function stopRec() {
  if (!isRecording) return;
  isRecording = false;
  clearInterval(recInterval);

  micBtn.classList.remove('recording');
  pulse.classList.add('hidden');
  micHint.textContent = 'Hold to speak ¬∑ Release to send';
  recTimer.classList.add('hidden');

  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
}

// Mouse events
micBtn.addEventListener('mousedown', e => { e.preventDefault(); startRec(); });
micBtn.addEventListener('mouseup', stopRec);
micBtn.addEventListener('mouseleave', stopRec);

// Touch events
micBtn.addEventListener('touchstart', e => { e.preventDefault(); startRec(); }, { passive: false });
micBtn.addEventListener('touchend', e => { e.preventDefault(); stopRec(); }, { passive: false });
micBtn.addEventListener('touchcancel', stopRec);

// ‚îÄ‚îÄ SEND AUDIO ‚îÄ‚îÄ
function sendAudio(blob, mimeType) {
  const ext = mimeType.includes('ogg') ? '.ogg' : '.webm';
  const formData = new FormData();
  formData.append('audio', blob, 'recording' + ext);
  formData.append('csrfmiddlewaretoken', CSRF);
  dispatch({ formData });
}

// ‚îÄ‚îÄ CORE DISPATCH ‚îÄ‚îÄ
async function dispatch({ text, formData }) {
  if (inputLocked || turnCount >= 3) return;
  lockInput(true);

  const pendingEl = addUserBubble(text || 'üéô Recording...', !text);
  showTyping(true);
  scrollDown();

  try {
    let res;
    if (formData) {
      res = await fetch(`/api/chat/${SCENARIO_ID}/`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });
    } else {
      res = await fetch(`/api/chat/${SCENARIO_ID}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': CSRF
        },
        body: JSON.stringify({ text })
      });
    }

    const data = await res.json();

    if (!res.ok || !data.success) throw new Error(data.error || 'Something went wrong');

    // Update user bubble with actual transcript
    if (data.student_said && pendingEl) {
      const span = pendingEl.querySelector('.msg-text');
      if (span) span.textContent = data.student_said;
      pendingEl.querySelector('.bubble-user')?.classList.remove('opacity-60');
    }

    showTyping(false);
    turnCount++;
    turnNum.textContent = Math.min(turnCount + 1, 3);

    if (data.feedback?.overall_score) scores.push(data.feedback.overall_score);

    addAIMessage(data);

    if (data.session_complete) {
      setTimeout(() => showComplete(data), 1200);
    } else {
      lockInput(false);
    }

  } catch (err) {
    showTyping(false);
    addErrorBubble(err.message);
    lockInput(false);
  }

  scrollDown();
}

// ‚îÄ‚îÄ UI BUILDERS ‚îÄ‚îÄ

function addUserBubble(text, pending = false) {
  const wrap = document.createElement('div');
  wrap.className = 'flex justify-end';
  wrap.innerHTML = `
    <div class="max-w-[78%]">
      <div class="bubble-user px-4 py-3 text-sm leading-relaxed ${pending ? 'opacity-60' : ''}">
        <span class="msg-text">${esc(text)}</span>
      </div>
      <p class="text-xs text-gray-400 mt-1 text-right mr-1">You</p>
    </div>`;
  msgContainer.appendChild(wrap);
  return wrap;
}

function addAIMessage(data) {
  const score = data.feedback?.overall_score ?? 0;
  const fb = data.feedback || {};
  const phrases = fb.better_phrases || [];
  const scoreColor = score >= 75 ? '#22C55E' : score >= 55 ? '#F59E0B' : '#EF4444';
  const scoreLabel = score >= 75 ? 'Great!' : score >= 55 ? 'Not bad!' : 'Keep trying!';
  const autoExpand = score < 70;

  // Build phrases HTML
  const phrasesHtml = phrases.map(p => `
    <div class="flex items-start gap-2 mt-2.5">
      <button onclick="speakText('${esc(p.phrase)}')"
        class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 hover:opacity-80 transition-opacity mt-0.5"
        style="background: #eef2ff">
        <svg width="12" height="12" fill="#4169E1" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
      </button>
      <div>
        <p class="text-sm font-semibold text-gray-800">${esc(p.phrase)}</p>
        <p class="mono text-xs text-indigo-500 mt-0.5 tracking-wide">${esc(p.phonetic || '')}</p>
      </div>
    </div>`).join('');

  const feedbackInner = `
    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4 feedback-card text-sm">
      <div class="grid grid-cols-3 gap-2 mb-3">
        <div class="bg-blue-50 rounded-xl p-2 text-center">
          <p class="text-xs text-blue-400 mb-1 font-medium">Fluency</p>
          <p class="text-xs text-gray-700 leading-snug">${esc(fb.fluency || '‚Äî')}</p>
        </div>
        <div class="bg-yellow-50 rounded-xl p-2 text-center">
          <p class="text-xs text-yellow-500 mb-1 font-medium">Grammar</p>
          <p class="text-xs text-gray-700 leading-snug">${esc(fb.grammar || '‚Äî')}</p>
        </div>
        <div class="bg-green-50 rounded-xl p-2 text-center">
          <p class="text-xs text-green-500 mb-1 font-medium">Tone</p>
          <p class="text-xs text-gray-700 leading-snug">${esc(fb.tone || '‚Äî')}</p>
        </div>
      </div>
      ${phrases.length ? `
        <div class="border-t border-gray-100 pt-3">
          <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Try saying:</p>
          ${phrasesHtml}
        </div>` : ''}
      ${data.manglish_hint ? `
        <div class="mt-3 bg-indigo-50 rounded-xl px-3 py-2.5 flex gap-2">
          <span class="text-base flex-shrink-0">üí°</span>
          <p class="text-xs text-indigo-700 leading-snug">${esc(data.manglish_hint)}</p>
        </div>` : ''}
    </div>`;

  const wrap = document.createElement('div');
  wrap.className = 'flex items-end gap-2';
  wrap.innerHTML = `
    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-base flex-shrink-0">${SCENARIO_ICON}</div>
    <div class="flex-1 max-w-[85%]">
      <div class="bubble-ai px-4 py-3 text-sm leading-relaxed text-gray-800">
        ${esc(data.ai_reply || '')}
      </div>
      <div class="mt-1.5 flex items-center gap-2">
        <button class="fb-toggle flex items-center gap-1.5 score-pop" onclick="toggleFeedback(this)">
          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-white text-xs font-semibold" style="background:${scoreColor}">
            ${score} &bull; ${scoreLabel}
          </span>
          <span class="text-xs text-gray-400 fb-arrow">${autoExpand ? '‚ñæ' : '‚ñ∏'} Feedback</span>
        </button>
      </div>
      <div class="mt-2 fb-panel ${autoExpand ? '' : 'hidden'}">
        ${feedbackInner}
      </div>
    </div>`;

  msgContainer.appendChild(wrap);
  return wrap;
}

function toggleFeedback(btn) {
  const panel = btn.parentElement.nextElementSibling;
  const arrow = btn.querySelector('.fb-arrow');
  const isHidden = panel.classList.toggle('hidden');
  arrow.textContent = isHidden ? '‚ñ∏ Feedback' : '‚ñæ Feedback';
}

function addErrorBubble(msg) {
  const div = document.createElement('div');
  div.className = 'flex justify-center';
  div.innerHTML = `<div class="bg-red-50 text-red-500 text-xs px-4 py-2 rounded-full border border-red-100">${esc(msg)}</div>`;
  msgContainer.appendChild(div);
}

function showTyping(show) {
  typing.classList.toggle('hidden', !show);
}

function lockInput(locked) {
  inputLocked = locked;
  micBtn.disabled = locked;
  sendBtn.disabled = locked;
  txtInput.disabled = locked;
  micBtn.style.opacity = locked ? '0.4' : '1';
}

function scrollDown() {
  setTimeout(() => { chatArea.scrollTop = chatArea.scrollHeight; }, 80);
}

// ‚îÄ‚îÄ TTS ‚îÄ‚îÄ
function speakText(text) {
  if (!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-IN';
  u.rate = 0.82;
  speechSynthesis.speak(u);
}

// ‚îÄ‚îÄ SESSION COMPLETE ‚îÄ‚îÄ
function showComplete(data) {
  const avg = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
  const col = avg >= 75 ? '#22C55E' : avg >= 55 ? '#F59E0B' : '#EF4444';

  document.getElementById('done-score').innerHTML = `
    <div class="w-20 h-20 rounded-full border-4 flex items-center justify-center mb-3" style="border-color:${col}">
      <span class="text-2xl font-bold heading" style="color:${col}">${avg}</span>
    </div>
    <p class="text-sm text-gray-500">Average over ${scores.length} turn${scores.length > 1 ? 's' : ''}</p>
    ${avg >= 75 ? '<p class="text-sm text-green-600 mt-1 font-medium">Excellent effort! üåü</p>'
      : avg >= 55 ? '<p class="text-sm text-yellow-600 mt-1 font-medium">Good attempt! Keep practising.</p>'
      : '<p class="text-sm text-orange-600 mt-1 font-medium">Don\'t give up! Try again. üí™</p>'}`;

  document.getElementById('done-modal').classList.remove('hidden');

  document.getElementById('retry-btn').addEventListener('click', async () => {
    await fetch(`/api/reset/${SCENARIO_ID}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' }
    });
    location.replace(location.pathname + '?reset=1');
  });
}

// ‚îÄ‚îÄ HTML ESCAPE ‚îÄ‚îÄ
function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// Initial scroll
scrollDown();
</script>
</body>
</html>
